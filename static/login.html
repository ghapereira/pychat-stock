<!DOCTYPE html>
    <head>
        <meta charset="UTF-8">
    </head>

    <div id="logndiv">
        <form id="loginform">
            <input type="text" id="username">
            <input type="password" id="password">
            <input type="button" value="login" onclick="runlogin()">
        </form>
    </div>

    <hr/>
    Available Chatrooms:
    <br/>
    <div id="availableChatrooms" style="border: 1px solid black;"></div>

    <hr/>

    <div id="chatdiv">
        <div id="chatroom">
            Chatroom: <span id="chatroomId" style="border: 3px solid red;"></span>
            <button id="showmessages" onclick="refreshChatroomMessages()">Refresh</button>
            <div id="messages"></div>
        </div>

        <hr/>

        <div id="postdiv" style="border: 2px solid black" contenteditable="true">
            type your message...
        </div>
        <button id="sendMessage" onclick="sendMessageToChatroom()">Send!</button>

        </div>
        <hr/>
    </div>


    <script>
        var sessionId = '',
            token = '',
            x = '';

        const baseURL = 'http://127.0.0.1:8000/v1';

        function json(response) {
            x = response;
            return response.json();
        }


        var runlogin = async function() {
            let username = document.getElementById('username').value,
                password = document.getElementById('password').value,
                url = `${baseURL}/login`;

            const data = {"username": username, "password": password};

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            response.json().then(loginData => {
                sessionId = loginData.session_id;
                token = loginData.token;
                showAvailableChatrooms();
            });
        };

        var refreshChatroomMessages = async function() {
            let chatroomId = document.getElementById('chatroomId').innerText,
                username = document.getElementById('username').value,
                url = `${baseURL}/chatroom/${chatroomId}`;

            let chatroomMessages = document.getElementById('messages');

            chatroomMessages.innerHTML = '';

            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'X-Token': token,
                    'X-User': username,
                    'X-SessionId': sessionId
                }
            });

            response.json().then(responseData => {
                for(message of responseData) {
                    var node = document.createElement('div');
                    node.innerText = message.text;
                    chatroomMessages.appendChild(node);
                }
            });
        };

        var sendMessageToChatroom = async function() {
            let messageText = document.getElementById('postdiv').innerText;

            let chatroomId = document.getElementById('chatroomId').innerText,
                username = document.getElementById('username').value,
                url = `${baseURL}/chatroom/${chatroomId}`;

            const data = {'text': messageText};

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Token': token,
                    'X-User': username,
                    'X-SessionId': sessionId
                },
                body: JSON.stringify(data)
            });

            await refreshChatroomMessages();
        };

        var showAvailableChatrooms = async function() {
            let availableChatrooms = document.getElementById('availableChatrooms'),
                username = document.getElementById('username').value,
                url = `${baseURL}/chatroom`;

            availableChatrooms.innerHTML = '';

            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'X-Token': token,
                    'X-User': username,
                    'X-SessionId': sessionId
                }
            });

            response.json().then(responseData => {
                for(message of responseData) {
                    var node = document.createElement('div');
                    node.innerText = message.uuid;
                    node.onclick = function() {
                        let chatroomId = document.getElementById('chatroomId');
                        chatroomId.innerText = this.innerText;
                        refreshChatroomMessages();
                    };

                    availableChatrooms.appendChild(node);
                }
            });
        };

    </script>
</html>
